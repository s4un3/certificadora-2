#include <Wire.h>
#include <Adafruit_GFX.h>
#include <Adafruit_SSD1306.h>

// OLED Display parameters
#define SCREEN_WIDTH 128
#define SCREEN_HEIGHT 64
#define OLED_RESET -1
#define SCREEN_ADDRESS 0x3C

Adafruit_SSD1306 display(SCREEN_WIDTH, SCREEN_HEIGHT, &Wire, OLED_RESET);

#include "monitor.h"

// implementação de um braômetro com base na abstrata Barometro
class Barometro1600psi : public Barometro {
    public:
        int pino;
        Barometro1600psi(int pino){
            this->pino = pino;
        }
        double medir() override {
            float medida = analogRead(pino);
            const int pressao_maxima = 1600;
            const int minimo = 1024.0/5.0 * 0.5; // 0.5 V = 0 psi
            const int maximo = 1024.0/5.0 * 4.5; // 4.5 V = pressao_maxima
            return (double) map(medida, minimo, maximo, 0, pressao_maxima);
        }
};

// instanciar os barômetros e colocar em variáveis para não sair de escopo
// NUNCA usar A4 e A5 pois o protocolo I²C para o display utilizará estes pinos
Barometro1600psi DD(A0);
Barometro1600psi DE(A1);
Barometro1600psi TD(A2);
Barometro1600psi TE(A3);
// inicializar a variável "barometros" obrigatória
GrupoBarometros barometros(&DD, &DE, &TD, &TE);

static const unsigned char PROGMEM carro [] = {0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00001111, 0b11111111, 0b11111000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b01111111, 0b11111111, 0b10000000, 0b00000000, 0b00001111, 0b11111111, 0b11111000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b01111111, 0b11111111, 0b10000000, 0b00000000, 0b00111111, 0b11111111, 0b11111110, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000001, 0b11111111, 0b11111111, 0b11100000, 0b00000000, 0b00111111, 0b11111111, 0b11111110, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000001, 0b11111111, 0b11111111, 0b11100000, 0b00000000, 0b00111111, 0b11111111, 0b11111110, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000001, 0b11111111, 0b11111111, 0b11100000, 0b00000000, 0b00111111, 0b11111111, 0b11111110, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000001, 0b11111111, 0b11111111, 0b11100000, 0b00000000, 0b00111111, 0b11111111, 0b11111110, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000001, 0b11111111, 0b11111111, 0b11100000, 0b00000000, 0b00111111, 0b11111111, 0b11111110, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000001, 0b11111111, 0b11111111, 0b11100000, 0b00000000, 0b00111111, 0b11111111, 0b11111110, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000001, 0b11111111, 0b11111111, 0b11100000, 0b00000000, 0b00111111, 0b11111111, 0b11111110, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000001, 0b11111111, 0b11111111, 0b11100000, 0b00000000, 0b00001111, 0b11111111, 0b11111000, 0b00000000, 0b00011111, 0b11111111, 0b10000000, 0b00000000, 0b01111111, 0b11111111, 0b10000000, 0b00000000, 0b00001111, 0b11111111, 0b11111000, 0b00000000, 0b00011111, 0b11111111, 0b10000000, 0b00000000, 0b01111111, 0b11111111, 0b10000000, 0b00000000, 0b00000000, 0b00011111, 0b11000000, 0b00000011, 0b11100000, 0b00000000, 0b01111000, 0b00000000, 0b00000111, 0b11000000, 0b00000000, 0b00000000, 0b00000000, 0b00011111, 0b11000000, 0b00000011, 0b11100000, 0b00000000, 0b01111000, 0b00000000, 0b00000111, 0b11000000, 0b00000000, 0b00000000, 0b00000000, 0b00011111, 0b11000000, 0b00000011, 0b11100000, 0b00000000, 0b01111000, 0b00000000, 0b00000111, 0b11000000, 0b00000000, 0b00000111, 0b11111111, 0b10011111, 0b00111111, 0b11111100, 0b00000001, 0b11110000, 0b00000110, 0b00000000, 0b00000111, 0b11000000, 0b00000000, 0b00000111, 0b11111111, 0b10011111, 0b00111111, 0b11111100, 0b00000001, 0b11110000, 0b00000110, 0b00000000, 0b00000111, 0b11000000, 0b00000000, 0b00000111, 0b00110001, 0b10011111, 0b00000000, 0b00000000, 0b00000001, 0b11111111, 0b10000001, 0b11110000, 0b00000111, 0b11000000, 0b00000000, 0b00000111, 0b00110001, 0b10011111, 0b00000000, 0b00000000, 0b00000001, 0b11111111, 0b10000001, 0b11110000, 0b00000111, 0b11000000, 0b00000000, 0b00000111, 0b00110001, 0b10011111, 0b00000000, 0b00000000, 0b00000001, 0b11111111, 0b10000001, 0b11110000, 0b00000111, 0b11000000, 0b00000000, 0b00000111, 0b00110001, 0b10011111, 0b00000001, 0b11111111, 0b11111111, 0b11111111, 0b11111111, 0b11111111, 0b11111111, 0b11111111, 0b10000000, 0b00000111, 0b00110001, 0b10011111, 0b00000001, 0b11111111, 0b11111111, 0b11111111, 0b11111111, 0b11111111, 0b11111111, 0b11111111, 0b10000000, 0b00000111, 0b00110001, 0b11111100, 0b00000001, 0b10000000, 0b00000110, 0b00000000, 0b00011000, 0b00000000, 0b00000000, 0b00000001, 0b11100000, 0b00000111, 0b00110001, 0b11111100, 0b00000001, 0b10000000, 0b00000110, 0b00000000, 0b00011000, 0b00000000, 0b00000000, 0b00000001, 0b11100000, 0b00000111, 0b00110001, 0b11111100, 0b11111111, 0b10000000, 0b00000110, 0b00000000, 0b00011000, 0b00000000, 0b00000000, 0b00000001, 0b11100000, 0b00000111, 0b00110001, 0b11111100, 0b11111111, 0b10000000, 0b00000110, 0b01111111, 0b10011110, 0b00000000, 0b00000001, 0b11000001, 0b11100000, 0b00000111, 0b00110001, 0b11111100, 0b11111111, 0b10000000, 0b00000110, 0b01111111, 0b10011110, 0b00000000, 0b00000001, 0b11000001, 0b11100000, 0b00000111, 0b00110001, 0b11111100, 0b11111111, 0b10000000, 0b00000110, 0b00000000, 0b00011000, 0b00000000, 0b00000000, 0b00000001, 0b11100000, 0b00000111, 0b00110001, 0b11111100, 0b00000001, 0b10000000, 0b00000110, 0b00000000, 0b00011000, 0b00000000, 0b00000000, 0b00000001, 0b11100000, 0b00000111, 0b00110001, 0b11111100, 0b00000001, 0b10000000, 0b00000110, 0b00000000, 0b00011000, 0b00000000, 0b00000000, 0b00000001, 0b11100000, 0b00000111, 0b00110001, 0b10011111, 0b00000001, 0b11111111, 0b11111111, 0b11111111, 0b11111111, 0b11111111, 0b11111111, 0b11111111, 0b10000000, 0b00000111, 0b00110001, 0b10011111, 0b00000001, 0b11111111, 0b11111111, 0b11111111, 0b11111111, 0b11111111, 0b11111111, 0b11111111, 0b10000000, 0b00000111, 0b00110001, 0b10011111, 0b00000000, 0b00000000, 0b00000001, 0b11111111, 0b10000001, 0b11110000, 0b00000111, 0b11000000, 0b00000000, 0b00000111, 0b00110001, 0b10011111, 0b00000000, 0b00000000, 0b00000001, 0b11111111, 0b10000001, 0b11110000, 0b00000111, 0b11000000, 0b00000000, 0b00000111, 0b00110001, 0b10011111, 0b00000000, 0b00000000, 0b00000001, 0b11111111, 0b10000001, 0b11110000, 0b00000111, 0b11000000, 0b00000000, 0b00000111, 0b11111111, 0b10011111, 0b00111111, 0b11111100, 0b00000001, 0b11110000, 0b00000110, 0b00000000, 0b00000111, 0b11000000, 0b00000000, 0b00000111, 0b11111111, 0b10011111, 0b00111111, 0b11111100, 0b00000001, 0b11110000, 0b00000110, 0b00000000, 0b00000111, 0b11000000, 0b00000000, 0b00000000, 0b00000000, 0b00011111, 0b11000000, 0b00000011, 0b11100000, 0b00000000, 0b01111000, 0b00000000, 0b00000111, 0b11000000, 0b00000000, 0b00000000, 0b00000000, 0b00011111, 0b11000000, 0b00000011, 0b11100000, 0b00000000, 0b01111000, 0b00000000, 0b00000111, 0b11000000, 0b00000000, 0b00000000, 0b00000000, 0b00011111, 0b11000000, 0b00000011, 0b11100000, 0b00000000, 0b01111000, 0b00000000, 0b00000111, 0b11000000, 0b00000000, 0b00000000, 0b00001111, 0b11111111, 0b11111000, 0b00000000, 0b00011111, 0b11111111, 0b10000000, 0b00000000, 0b01111111, 0b11111111, 0b10000000, 0b00000000, 0b00001111, 0b11111111, 0b11111000, 0b00000000, 0b00011111, 0b11111111, 0b10000000, 0b00000000, 0b01111111, 0b11111111, 0b10000000, 0b00000000, 0b00111111, 0b11111111, 0b11111110, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000001, 0b11111111, 0b11111111, 0b11100000, 0b00000000, 0b00111111, 0b11111111, 0b11111110, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000001, 0b11111111, 0b11111111, 0b11100000, 0b00000000, 0b00111111, 0b11111111, 0b11111110, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000001, 0b11111111, 0b11111111, 0b11100000, 0b00000000, 0b00111111, 0b11111111, 0b11111110, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000001, 0b11111111, 0b11111111, 0b11100000, 0b00000000, 0b00111111, 0b11111111, 0b11111110, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000001, 0b11111111, 0b11111111, 0b11100000, 0b00000000, 0b00111111, 0b11111111, 0b11111110, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000001, 0b11111111, 0b11111111, 0b11100000, 0b00000000, 0b00111111, 0b11111111, 0b11111110, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000001, 0b11111111, 0b11111111, 0b11100000, 0b00000000, 0b00111111, 0b11111111, 0b11111110, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000001, 0b11111111, 0b11111111, 0b11100000, 0b00000000, 0b00001111, 0b11111111, 0b11111000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b01111111, 0b11111111, 0b10000000, 0b00000000, 0b00001111, 0b11111111, 0b11111000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b01111111, 0b11111111, 0b10000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000, 0b00000000
};

#define IMG_HEIGHT   64
#define IMG_WIDTH    96

char buffer[32] = {};

void setup(){
    display.begin(SSD1306_SWITCHCAPVCC, SCREEN_ADDRESS);
    display.clearDisplay(); 
    display.setTextSize(1);
    display.setTextColor(SSD1306_WHITE, SSD1306_BLACK);

    display.drawBitmap(
        (display.width()  - IMG_WIDTH ) / 2,
        (display.height() - IMG_HEIGHT) / 2,
        carro, IMG_WIDTH, IMG_HEIGHT, 1);
    display.display();

    buffer[2] = ':'; buffer[3] = ' ';
}

void loop(){
    Medida m = barometros.medir();
    const int POS_X = 75;
    const int POS_Y = 57;

    display.setCursor(0,0);
    buffer[0] = 'T'; buffer[1] = 'E';
    dtostrf(m.TE, 4, 0, buffer + 4);
    display.print(buffer);

    display.setCursor(POS_X, 0);
    buffer[0] = 'D';
    dtostrf(m.DE, 4, 0, buffer + 4);
    display.print(buffer);

    display.setCursor(0, POS_Y);
    buffer[0] = 'T'; buffer[1] = 'D';
    dtostrf(m.TD, 4, 0, buffer + 4);
    display.print(buffer);

    display.setCursor(POS_X, POS_Y);
    buffer[0] = 'D'; buffer[1] = 'D';
    dtostrf(m.DD, 4, 0, buffer + 4);
    display.print(buffer);

    display.display();
    delay(100);
}
